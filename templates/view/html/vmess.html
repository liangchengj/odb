<!DOCTYPE html>
<html lang="cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style rel="stylesheet" type="text/css">
      * {
        margin: 0;
        padding: 0;
      }
      .wrapper {
        width: 90%;
        margin: 75px auto 0;
      }
      .left {
        float: left;
        width: 49%;
        height: 675px;
      }
      .right {
        float: right;
        width: 49%;
        height: 600px;
        display: none;
      }
      .right .inner {
        width: 540px;
        margin: 0 auto;
      }
      .right textarea {
        width: 100%;
        height: 100px;
        margin-top: 30px;
      }
      textarea {
        padding: 5px;
        font-size: 1.3rem;
        border: 3px gray solid;
        border-radius: 5px;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-qrcode2@1.0.0/dist/jquery-qrcode.min.js"></script>

    <title>Vmess 链接互转</title>
  </head>
  <body>
    <div class="wrapper">
      <textarea
        placeholder="请输入Vmess链接"
        id="input"
        class="left"
      ></textarea>
      <div class="right">
        <div class="inner">
          <div id="qrcode"></div>
          <textarea id="output" readonly></textarea>
        </div>
      </div>
    </div>
    <script type="application/javascript">
      function decodeVmess(url) {
        let vmessUrl = url;
        vmessUrl = vmessUrl.replace("vmess://", "");
        vmessUrl = atob(vmessUrl);
        return vmessUrl;
      }

      function encodeVmess(url) {
        return `vmess://${btoa(url)}`;
      }

      function quantumultToV2ray(url) {
        let vmessUrl = url;
        vmessUrl = decodeVmess(vmessUrl);
        let propsArr = vmessUrl.split(/,[ ]*/);
        let config = {
          v: 2,
          ps: propsArr[0] ? propsArr[0].replace(/[ ]*=[ ]*vmess$/, "") : undefined,
          add: propsArr[1] ? propsArr[1] : undefined,
          port: propsArr[2] ? propsArr[2] : undefined,
          id: propsArr[4] ? propsArr[4].replace(/^\"(.*)\"$/gi, "$1") : undefined,
          aid: 0,
          net: propsArr[8] ? propsArr[8].replace(/^obfs[ ]*=[ ]*/, "") : undefined,
          type: propsArr[3] ? propsArr[3] : undefined,
          host: propsArr[6] ? propsArr[6].replace(/^tls-host[ ]*=[ ]*/, "") : undefined,
          path: propsArr[9] ? propsArr[9].replace(/^obfs-path[ ]*=[ ]*\"(.*)\"$/gi, "$1") : undefined,
          tls: propsArr[5] ? (propsArr[5].replace(/^over-tls[ ]*=[ ]*/, "") ? "tls" : "")  : undefined,
        };

        return encodeVmess(JSON.stringify(config));
      }

      function v2rayToQuantumult(url) {
        let vmessUrl = url;
        vmessUrl = decodeVmess(vmessUrl);
        let config = JSON.parse(vmessUrl);
        let qVmess = `${config.ps} = vmess,${config.add},${config.port},${
          config.type
        },"${config.id}",over-tls=${config.tls === "tls"},tls-host=${
          config.host
        },certificate=${config.tls === "tls" ? 1 : 0},obfs=${
          config.net
        },obfs-path="${config.path}",obfs-header="${config.tls === 'tls' ? 'Host:' + config.host : '' }"`;

        return encodeVmess(qVmess);
      }

      function genQrCode(vmessUrl, label) {
        let options = {
          render: "canvas",
          ecLevel: "H",
          minVersion: 6,
          fill: "#333333",
          background: "white",
          text: vmessUrl,
          size: 540,
          radius: 0.01 * 50,
          quiet: 1,
          mode: 2,
          mSize: 0.01 * 11,
          mPosX: 0.01 * 50,
          mPosY: 0.01 * 50,
          label: label,
          fontname: "sans",
          fontcolor: "#ff9818",
          image: null,
        };
        $("#qrcode").empty().qrcode(options);
      }

      document.getElementById("input").onchange = function () {
        let output = document.getElementById("output");

        if (this.value.startsWith("vmess://")) {
          let result;
          $(".right").css({ display: "block" });
          try {
            result = v2rayToQuantumult(this.value);
            output.value = result;
            genQrCode(result, " Quantumult ");
          } catch (error) {
            result = quantumultToV2ray(this.value);
            output.value = result;
            genQrCode(result, " v2rayN ");
          }
        } else if (this.value !== "") {
          alert("请输入正确的Vmess链接");
        }
      };
    </script>
  </body>
</html>
